{% extends "base_realtime.html" %}

{% block title %}Statistical Analysis - BitAxe{% endblock %}
{% block page_title %}Statistical Analysis Dashboard{% endblock %}
{% block page_subtitle %}Advanced statistical analysis and performance profiling{% endblock %}

{% block page_actions %}
<div class="analytics-controls">
    <div class="timeframe-selector">
        <select id="timeframe-select" class="form-select" onchange="updateTimeframe()">
            <option value="24" {% if analysis_period.hours == 24 %}selected{% endif %}>Last 24 Hours</option>
            <option value="168" {% if analysis_period.hours == 168 %}selected{% endif %}>Last 7 Days</option>
            <option value="720" {% if analysis_period.hours == 720 %}selected{% endif %}>Last 30 Days</option>
        </select>
    </div>
    <button class="btn btn-primary" onclick="refreshAnalysis()">
        <i data-lucide="refresh-cw"></i>
        Refresh Analysis
    </button>
</div>
{% endblock %}

{% block content %}
<!-- Analysis Overview -->
<div class="analysis-overview">
    <div class="overview-card">
        <h3>Analysis Period</h3>
        <p><strong>{{ (analysis_period.start | replace('T', ' ') | replace('.000Z', ''))[:19] }}</strong> to <strong>{{ (analysis_period.end | replace('T', ' ') | replace('.000Z', ''))[:19] }}</strong></p>
        <p>Total miners analyzed: <strong>{{ profiles | length }}</strong></p>
    </div>
</div>

<!-- Performance Profiles Grid -->
<div class="profiles-section">
    <h2>Miner Performance Profiles</h2>
    
    <div class="profiles-grid">
        {% for ip, profile in profiles.items() %}
        <div class="profile-card grade-{{ profile.performance.grade.lower() }}">
            <div class="profile-header">
                <h3>{{ ip }}</h3>
                <div class="grade-badge grade-{{ profile.performance.grade.lower() }}">
                    Grade {{ profile.performance.grade }}
                </div>
            </div>
            
            <div class="profile-metrics">
                <div class="metric-group">
                    <h4>Hashrate Performance</h4>
                    <div class="metrics-row">
                        <div class="metric">
                            <span class="label">Average</span>
                            <span class="value">{{ "%.1f"|format(profile.hashrate_stats.avg) }} GH/s</span>
                        </div>
                        <div class="metric">
                            <span class="label">Stability</span>
                            <span class="value">{{ "%.1f"|format(profile.performance.stability_score) }}%</span>
                        </div>
                    </div>
                </div>
                
                <div class="metric-group">
                    <h4>Temperature Stats</h4>
                    <div class="metrics-row">
                        <div class="metric">
                            <span class="label">Average</span>
                            <span class="value">{{ "%.1f"|format(profile.temperature_stats.avg) }}°C</span>
                        </div>
                        <div class="metric">
                            <span class="label">Max</span>
                            <span class="value">{{ "%.1f"|format(profile.temperature_stats.max) }}°C</span>
                        </div>
                    </div>
                </div>
                
                <div class="metric-group">
                    <h4>Efficiency & Events</h4>
                    <div class="metrics-row">
                        <div class="metric">
                            <span class="label">Efficiency</span>
                            <span class="value">{{ "%.3f"|format(profile.efficiency_stats.avg) }} GH/W</span>
                        </div>
                        <div class="metric">
                            <span class="label">Anomalies</span>
                            <span class="value">{{ profile.events.anomalies }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="metric-group">
                    <h4>Operational Status</h4>
                    <div class="metrics-row">
                        <div class="metric">
                            <span class="label">Uptime</span>
                            <span class="value">{{ "%.1f"|format(profile.operational.uptime_percentage) }}%</span>
                        </div>
                        <div class="metric">
                            <span class="label">Data Quality</span>
                            <span class="value">{{ "%.1f"|format(profile.operational.data_completeness) }}%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% if profiles | length == 0 %}
        <div class="no-data-message">
            <i data-lucide="bar-chart-3"></i>
            <h3>No Performance Data Available</h3>
            <p>No statistical analysis data found for the selected time period. Ensure miners are running and data is being collected.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Fleet Comparison -->
{% if comparison_data and comparison_data.rankings %}
<div class="comparison-section">
    <h2>Fleet Performance Comparison</h2>
    
    <div class="comparison-grid">
        <!-- Fleet Statistics -->
        <div class="fleet-stats-card">
            <h3>Fleet Overview</h3>
            <div class="fleet-metrics">
                <div class="metric">
                    <span class="label">Total Hashrate</span>
                    <span class="value">{{ "%.2f"|format(comparison_data.fleet_stats.total_hashrate / 1000) }} TH/s</span>
                </div>
                <div class="metric">
                    <span class="label">Average Efficiency</span>
                    <span class="value">{{ "%.3f"|format(comparison_data.fleet_stats.avg_efficiency) }} GH/W</span>
                </div>
                <div class="metric">
                    <span class="label">Average Stability</span>
                    <span class="value">{{ "%.1f"|format(comparison_data.fleet_stats.avg_stability) }}%</span>
                </div>
            </div>
            
            <div class="grade-distribution">
                <h4>Grade Distribution</h4>
                <div class="grade-bars">
                    {% for grade, count in comparison_data.fleet_stats.grade_distribution.items() %}
                    <div class="grade-bar">
                        <span class="grade-label">{{ grade }}</span>
                        <div class="bar">
                            <div class="bar-fill grade-{{ grade.lower() }}" style="width: {{ (count / (comparison_data.fleet_stats.grade_distribution.values() | sum) * 100) if (comparison_data.fleet_stats.grade_distribution.values() | sum) > 0 else 0 }}%"></div>
                        </div>
                        <span class="count">{{ count }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Rankings -->
        <div class="rankings-card">
            <h3>Performance Rankings</h3>
            
            <div class="ranking-tabs">
                <button class="tab-btn active" onclick="showRanking('efficiency')">Efficiency</button>
                <button class="tab-btn" onclick="showRanking('stability')">Stability</button>
                <button class="tab-btn" onclick="showRanking('overall')">Overall</button>
            </div>
            
            <div id="efficiency-ranking" class="ranking-list active">
                <h4>Top Performers by Efficiency</h4>
                {% for item in comparison_data.rankings.by_efficiency[:5] %}
                <div class="ranking-item">
                    <span class="rank">{{ item.rank }}</span>
                    <span class="ip">{{ item.ip }}</span>
                    <span class="value">{{ "%.3f"|format(item.value) }} GH/W</span>
                    <span class="grade grade-{{ item.grade.lower() }}">{{ item.grade }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div id="stability-ranking" class="ranking-list">
                <h4>Top Performers by Stability</h4>
                {% for item in comparison_data.rankings.by_stability[:5] %}
                <div class="ranking-item">
                    <span class="rank">{{ item.rank }}</span>
                    <span class="ip">{{ item.ip }}</span>
                    <span class="value">{{ "%.1f"|format(item.value) }}%</span>
                    <span class="grade grade-{{ item.grade.lower() }}">{{ item.grade }}</span>
                </div>
                {% endfor %}
            </div>
            
            <div id="overall-ranking" class="ranking-list">
                <h4>Overall Performance Rankings</h4>
                {% for item in comparison_data.rankings.by_overall_grade[:5] %}
                <div class="ranking-item">
                    <span class="rank">{{ item.rank }}</span>
                    <span class="ip">{{ item.ip }}</span>
                    <span class="efficiency">{{ "%.3f"|format(item.efficiency) }} GH/W</span>
                    <span class="grade grade-{{ item.grade.lower() }}">{{ item.grade }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Recommendations -->
    {% if comparison_data.recommendations %}
    <div class="recommendations-section">
        <h3>Recommended Actions</h3>
        <div class="recommendations-list">
            {% for rec in comparison_data.recommendations %}
            <div class="recommendation-item priority-{{ rec.priority }}">
                <div class="rec-icon">
                    <i data-lucide="{% if rec.type == 'temperature' %}thermometer{% elif rec.type == 'efficiency' %}trending-up{% elif rec.type == 'stability' %}activity{% else %}alert-circle{% endif %}"></i>
                </div>
                <div class="rec-content">
                    <div class="rec-title">{{ rec.miner }} - {{ rec.issue }}</div>
                    <div class="rec-action">{{ rec.recommendation }}</div>
                </div>
                <div class="rec-priority priority-{{ rec.priority }}">{{ rec.priority.title() }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/mobile-chart-optimization.js') }}"></script>
<script>
function updateTimeframe() {
    const select = document.getElementById('timeframe-select');
    const hours = select.value;
    window.location.href = `{{ url_for('statistical_analysis') }}?hours=${hours}`;
}

function refreshAnalysis() {
    window.location.reload();
}

function showRanking(type) {
    // Hide all ranking lists
    document.querySelectorAll('.ranking-list').forEach(list => {
        list.classList.remove('active');
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected ranking
    document.getElementById(type + '-ranking').classList.add('active');
    
    // Activate clicked tab
    event.target.classList.add('active');
}

// Initialize Lucide icons
document.addEventListener('DOMContentLoaded', function() {
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
});
</script>

<style>
.analysis-overview {
    margin-bottom: 2rem;
}

.overview-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.profiles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
    margin-top: 1rem;
}

.profile-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
    border-left: 4px solid var(--accent-color);
}

.profile-card.grade-a { border-left-color: #10b981; }
.profile-card.grade-b { border-left-color: #3b82f6; }
.profile-card.grade-c { border-left-color: #f59e0b; }
.profile-card.grade-d { border-left-color: #ef4444; }
.profile-card.grade-f { border-left-color: #dc2626; }

.profile-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.grade-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.875rem;
}

.grade-badge.grade-a { background: #10b981; color: white; }
.grade-badge.grade-b { background: #3b82f6; color: white; }
.grade-badge.grade-c { background: #f59e0b; color: white; }
.grade-badge.grade-d { background: #ef4444; color: white; }
.grade-badge.grade-f { background: #dc2626; color: white; }

.metric-group {
    margin-bottom: 1rem;
}

.metric-group h4 {
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-secondary);
}

.metrics-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 1rem;
}

.fleet-stats-card, .rankings-card {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    padding: 1.5rem;
}

.grade-bars {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.grade-bar {
    display: grid;
    grid-template-columns: 1rem 1fr 2rem;
    gap: 0.5rem;
    align-items: center;
}

.bar {
    height: 20px;
    background: var(--bg-secondary);
    border-radius: 4px;
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    transition: width 0.3s ease;
}

.bar-fill.grade-a { background: #10b981; }
.bar-fill.grade-b { background: #3b82f6; }
.bar-fill.grade-c { background: #f59e0b; }
.bar-fill.grade-d { background: #ef4444; }
.bar-fill.grade-f { background: #dc2626; }

.ranking-tabs {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.tab-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
}

.tab-btn.active {
    background: var(--accent-color);
    color: white;
}

.ranking-list {
    display: none;
}

.ranking-list.active {
    display: block;
}

.ranking-item {
    display: grid;
    grid-template-columns: 2rem 1fr auto auto;
    gap: 1rem;
    align-items: center;
    padding: 0.75rem;
    border-bottom: 1px solid var(--border-color);
}

.rank {
    font-weight: bold;
    color: var(--accent-color);
}

.recommendations-section {
    margin-top: 2rem;
}

.recommendations-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin-top: 1rem;
}

.recommendation-item {
    display: grid;
    grid-template-columns: auto 1fr auto;
    gap: 1rem;
    align-items: center;
    padding: 1rem;
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    border-left: 4px solid var(--border-color);
}

.recommendation-item.priority-high { border-left-color: #ef4444; }
.recommendation-item.priority-medium { border-left-color: #f59e0b; }
.recommendation-item.priority-low { border-left-color: #10b981; }

.rec-icon {
    color: var(--text-secondary);
}

.rec-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.rec-title {
    font-weight: 600;
}

.rec-action {
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.rec-priority {
    padding: 0.25rem 0.75rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.rec-priority.priority-high { background: #fef2f2; color: #dc2626; }
.rec-priority.priority-medium { background: #fffbeb; color: #d97706; }
.rec-priority.priority-low { background: #f0fdf4; color: #16a34a; }

.no-data-message {
    grid-column: 1 / -1;
    text-align: center;
    padding: 3rem;
    color: var(--text-secondary);
}

.no-data-message i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}
</style>
{% endblock %}