[supervisord]
nodaemon=true
user=root
pidfile=/var/run/supervisord.pid
logfile=/var/log/supervisor/supervisord.log
childlogdir=/var/log/supervisor

[program:nginx]
command=/usr/sbin/nginx -g "daemon off;"
autostart=true
autorestart=true
priority=10
stdout_logfile=/var/log/supervisor/nginx_stdout.log
stderr_logfile=/var/log/supervisor/nginx_stderr.log

[program:bitaxe_app]
command=/usr/local/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --worker-class gevent --worker-connections 1000 --timeout 120 --keep-alive 5 --max-requests 1000 --max-requests-jitter 50 --preload app:app
directory=/app
user=bitaxe
autostart=true
autorestart=true
priority=20
stdout_logfile=/var/log/supervisor/bitaxe_app_stdout.log
stderr_logfile=/var/log/supervisor/bitaxe_app_stderr.log
environment=
    FLASK_ENV=production,
    PYTHONPATH=/app,
    DATABASE_URL=postgresql://bitaxe:password@postgres:5432/bitaxe,
    REDIS_URL=redis://redis:6379/0

[program:ml_optimization_worker]
command=/usr/local/bin/python -m ml_engine.workers.optimization_worker
directory=/app
user=bitaxe
autostart=true
autorestart=true
priority=30
stdout_logfile=/var/log/supervisor/ml_worker_stdout.log
stderr_logfile=/var/log/supervisor/ml_worker_stderr.log
environment=
    PYTHONPATH=/app,
    DATABASE_URL=postgresql://bitaxe:password@postgres:5432/bitaxe,
    REDIS_URL=redis://redis:6379/0

[program:monitoring_collector]
command=/usr/local/bin/python -m monitoring.collector_daemon
directory=/app
user=bitaxe
autostart=true
autorestart=true
priority=40
stdout_logfile=/var/log/supervisor/monitoring_stdout.log
stderr_logfile=/var/log/supervisor/monitoring_stderr.log
environment=
    PYTHONPATH=/app,
    DATABASE_URL=postgresql://bitaxe:password@postgres:5432/bitaxe,
    REDIS_URL=redis://redis:6379/0

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface