<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitAxe Metrics Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .metric-chart {
            height: 300px;
            margin-bottom: 2rem;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-selector {
            position: sticky;
            top: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-microchip me-2"></i>BitAxe V2.0.0
            </a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" href="/">Dashboard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/monitoring">Monitoring</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/monitoring/health">Health</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/monitoring/metrics">Metrics</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1><i class="fas fa-chart-line me-2"></i>System Metrics</h1>
                    
                    <!-- Time Range Selector -->
                    <div class="time-selector">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="timeRange" id="time1h" value="1" {{ 'checked' if hours == 1 }}>
                            <label class="btn btn-outline-primary" for="time1h">1 Hour</label>

                            <input type="radio" class="btn-check" name="timeRange" id="time6h" value="6" {{ 'checked' if hours == 6 }}>
                            <label class="btn btn-outline-primary" for="time6h">6 Hours</label>

                            <input type="radio" class="btn-check" name="timeRange" id="time24h" value="24" {{ 'checked' if hours == 24 }}>
                            <label class="btn btn-outline-primary" for="time24h">24 Hours</label>

                            <input type="radio" class="btn-check" name="timeRange" id="time7d" value="168" {{ 'checked' if hours == 168 }}>
                            <label class="btn btn-outline-primary" for="time7d">7 Days</label>
                        </div>
                        
                        <button class="btn btn-success ms-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Metrics Charts -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-server me-2"></i>System Performance</h3>
            </div>
        </div>

        <div class="row">
            <!-- CPU Usage Chart -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-microchip me-2"></i>CPU Usage</h5>
                    <div id="cpu-chart" class="metric-chart"></div>
                </div>
            </div>

            <!-- Memory Usage Chart -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-memory me-2"></i>Memory Usage</h5>
                    <div id="memory-chart" class="metric-chart"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Disk Usage Chart -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-hdd me-2"></i>Disk Usage</h5>
                    <div id="disk-chart" class="metric-chart"></div>
                </div>
            </div>

            <!-- Temperature Chart -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-thermometer-half me-2"></i>System Temperature</h5>
                    <div id="temperature-chart" class="metric-chart"></div>
                </div>
            </div>
        </div>

        <!-- Network Metrics -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-network-wired me-2"></i>Network Activity</h3>
            </div>
        </div>

        <div class="row">
            <div class="col-12 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-wifi me-2"></i>Network Traffic</h5>
                    <div id="network-chart" class="metric-chart"></div>
                </div>
            </div>
        </div>

        <!-- Mining Metrics -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-coins me-2"></i>Mining Performance</h3>
            </div>
        </div>

        <div class="row">
            <!-- Total Hashrate -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-bolt me-2"></i>Total Hashrate</h5>
                    <div id="hashrate-chart" class="metric-chart"></div>
                </div>
            </div>

            <!-- Mining Efficiency -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-chart-line me-2"></i>Mining Efficiency</h5>
                    <div id="efficiency-chart" class="metric-chart"></div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Average Temperature -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-thermometer me-2"></i>Average Miner Temperature</h5>
                    <div id="miner-temp-chart" class="metric-chart"></div>
                </div>
            </div>

            <!-- Active Miners -->
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-server me-2"></i>Active Miners</h5>
                    <div id="miners-chart" class="metric-chart"></div>
                </div>
            </div>
        </div>

        <!-- Database Metrics -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-database me-2"></i>Database Performance</h3>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-hdd me-2"></i>Database Size</h5>
                    <div id="db-size-chart" class="metric-chart"></div>
                </div>
            </div>

            <div class="col-md-6 mb-4">
                <div class="chart-container">
                    <h5><i class="fas fa-clock me-2"></i>Query Response Time</h5>
                    <div id="db-response-chart" class="metric-chart"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Chart data from server
        const chartData = {{ chart_data|tojson }};
        
        // Default Plotly layout
        const defaultLayout = {
            showlegend: false,
            margin: { t: 30, r: 30, b: 50, l: 60 },
            xaxis: {
                title: 'Time',
                type: 'date'
            },
            yaxis: {
                title: 'Value'
            }
        };

        // Chart configuration
        const config = {
            responsive: true,
            displayModeBar: false
        };

        function createChart(containerId, dataKey, title, yAxisTitle, color = '#007bff') {
            if (!chartData[dataKey] || !chartData[dataKey].timestamps.length) {
                document.getElementById(containerId).innerHTML = 
                    '<div class="text-center text-muted p-4">No data available</div>';
                return;
            }

            const data = [{
                x: chartData[dataKey].timestamps,
                y: chartData[dataKey].values,
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: color, width: 2 },
                marker: { size: 4 },
                name: title
            }];

            const layout = {
                ...defaultLayout,
                title: title,
                yaxis: {
                    ...defaultLayout.yaxis,
                    title: yAxisTitle + (chartData[dataKey].unit ? ` (${chartData[dataKey].unit})` : '')
                }
            };

            Plotly.newPlot(containerId, data, layout, config);
        }

        // Create all charts
        function initializeCharts() {
            // System charts
            createChart('cpu-chart', 'system.cpu_usage_percent', 'CPU Usage', 'Percentage', '#dc3545');
            createChart('memory-chart', 'system.memory_usage_percent', 'Memory Usage', 'Percentage', '#28a745');
            createChart('disk-chart', 'system.disk_usage_percent', 'Disk Usage', 'Percentage', '#ffc107');
            createChart('temperature-chart', 'system.cpu_temperature', 'CPU Temperature', 'Temperature', '#fd7e14');

            // Network chart
            if (chartData['system.network_bytes_received'] && chartData['system.network_bytes_transmitted']) {
                const networkData = [
                    {
                        x: chartData['system.network_bytes_received'].timestamps,
                        y: chartData['system.network_bytes_received'].values,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Received',
                        line: { color: '#28a745' }
                    },
                    {
                        x: chartData['system.network_bytes_transmitted'].timestamps,
                        y: chartData['system.network_bytes_transmitted'].values,
                        type: 'scatter',
                        mode: 'lines',
                        name: 'Transmitted',
                        line: { color: '#dc3545' }
                    }
                ];

                const networkLayout = {
                    ...defaultLayout,
                    title: 'Network Traffic',
                    showlegend: true,
                    yaxis: {
                        ...defaultLayout.yaxis,
                        title: 'Data (MB)'
                    }
                };

                Plotly.newPlot('network-chart', networkData, networkLayout, config);
            } else {
                document.getElementById('network-chart').innerHTML = 
                    '<div class="text-center text-muted p-4">No network data available</div>';
            }

            // Mining charts
            createChart('hashrate-chart', 'mining.total_hashrate', 'Total Hashrate', 'Hashrate', '#6f42c1');
            createChart('efficiency-chart', 'mining.average_efficiency', 'Mining Efficiency', 'Efficiency', '#20c997');
            createChart('miner-temp-chart', 'mining.average_temperature', 'Average Temperature', 'Temperature', '#fd7e14');
            createChart('miners-chart', 'mining.active_miners', 'Active Miners', 'Count', '#6c757d');

            // Database charts
            createChart('db-size-chart', 'database.db_file_size', 'Database Size', 'Size', '#17a2b8');
            createChart('db-response-chart', 'database.query_response_time', 'Query Response Time', 'Time', '#e83e8c');
        }

        // Time range change handler
        document.addEventListener('change', function(e) {
            if (e.target.name === 'timeRange') {
                const hours = e.target.value;
                window.location.href = `/monitoring/metrics?hours=${hours}`;
            }
        });

        function refreshData() {
            const selectedHours = document.querySelector('input[name="timeRange"]:checked').value;
            window.location.href = `/monitoring/metrics?hours=${selectedHours}`;
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', initializeCharts);

        // Auto-refresh every 2 minutes
        setInterval(refreshData, 120000);
    </script>
</body>
</html>